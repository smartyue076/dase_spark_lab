version: '3.3'

services:
  spark-master:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-master
    user: root
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=172.23.166.104
      - SPARK_LOCAL_IP=172.23.166.104
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_EVENTLOG_ENABLED=true
      - SPARK_EVENTLOG_DIR=file:///tmp/spark-events
    command: >
      bash -c "
      mkdir -p /tmp/spark-events &&
      /opt/spark/sbin/start-master.sh -h 0.0.0.0 -p 7077 --webui-port 8080 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.master.Master-*.out"
    network_mode: "host"
    volumes:
      - /home/xuyue/dase_spark_lab:/opt/spark/work-dir:rw
      - /home/xuyue/dase_spark_lab/spark-events:/tmp/spark-events:rw
    restart: unless-stopped

  spark-worker-1:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-worker-1
    user: root
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://172.23.166.104:7077
      - SPARK_WORKER_MEMORY=1G
      - SPARK_WORKER_CORES=1
      - SPARK_LOCAL_IP=172.23.166.104
      - SPARK_WORKER_WEBUI_PORT=8081
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_EVENTLOG_ENABLED=true
      - SPARK_EVENTLOG_DIR=file:///tmp/spark-events
      - SPARK_LOCAL_DIRS=/tmp
      - SPARK_WORKER_OPTS=-Dspark.shuffle.service.enabled=true -Dspark.shuffle.service.port=7337
    command: >
      bash -c "
      sleep 5 && 
      /opt/spark/sbin/start-worker.sh --port 7081 --webui-port 8081 spark://172.23.166.104:7077 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.worker.Worker-*.out"
    network_mode: "host"
    volumes:
      - /home/xuyue/dase_spark_lab:/opt/spark/work-dir:rw
      - /home/xuyue/dase_spark_lab/spark-events:/tmp/spark-events:rw
      - /home/xuyue/dase_spark_lab/spark-shuffle:/tmp:rw
    depends_on:
      - spark-master
    restart: unless-stopped

  spark-worker-2:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-worker-2
    user: root
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://172.23.166.104:7077
      - SPARK_WORKER_MEMORY=1G
      - SPARK_WORKER_CORES=1
      - SPARK_LOCAL_IP=172.23.166.104
      - SPARK_WORKER_WEBUI_PORT=8087
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_EVENTLOG_ENABLED=true
      - SPARK_EVENTLOG_DIR=file:///tmp/spark-events
      - SPARK_LOCAL_DIRS=/tmp
      - SPARK_WORKER_OPTS=-Dspark.shuffle.service.enabled=true -Dspark.shuffle.service.port=7338
    command: >
      bash -c "
      sleep 5 && 
      /opt/spark/sbin/start-worker.sh --port 7087 --webui-port 8087 spark://172.23.166.104:7077 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.worker.Worker-*.out"
    network_mode: "host"
    volumes:
      - /home/xuyue/dase_spark_lab:/opt/spark/work-dir:rw
      - /home/xuyue/dase_spark_lab/spark-events:/tmp/spark-events:rw
      - /home/xuyue/dase_spark_lab/spark-shuffle:/tmp:rw
    depends_on:
      - spark-master
    restart: unless-stopped

  spark-history:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-history
    user: root
    environment:
      - SPARK_HISTORY_OPTS=-Dspark.history.fs.logDirectory=file:///tmp/spark-events -Dspark.history.ui.port=18080
    command: >
      bash -c "
      /opt/spark/bin/spark-class org.apache.spark.deploy.history.HistoryServer"
    network_mode: "host"
    volumes:
      - /home/xuyue/dase_spark_lab/spark-events:/tmp/spark-events:rw
    restart: unless-stopped
