version: '3.3'

services:
  spark-master:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-master
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_MASTER_HOST=0.0.0.0
      - SPARK_LOCAL_IP=0.0.0.0
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
    command: >
      bash -c "
      /opt/spark/sbin/start-master.sh -h 0.0.0.0 -p 7077 --webui-port 8080 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.master.Master-*.out"
    network_mode: "host"
    restart: unless-stopped

  spark-worker-1:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-worker-1
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://localhost:7077
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_WORKER_WEBUI_PORT=8081
      - SPARK_WORKER_HOST=0.0.0.0
      - SPARK_LOCAL_IP=0.0.0.0
      - SPARK_WORKER_PORT=7081
    command: >
      bash -c "
      sleep 10 &&
      /opt/spark/sbin/start-worker.sh spark://localhost:7077 --webui-port 8081 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.worker.Worker-*.out"
    network_mode: "host"
    depends_on:
      - spark-master
    restart: unless-stopped

  spark-worker-2:
    image: apache/spark:3.5.7-python3
    container_name: xy-spark-worker-2
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://localhost:7077
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_WORKER_WEBUI_PORT=8082
      - SPARK_WORKER_HOST=0.0.0.0
      - SPARK_LOCAL_IP=0.0.0.0
      - SPARK_WORKER_PORT=7082
    command: >
      bash -c "
      sleep 15 &&
      /opt/spark/sbin/start-worker.sh spark://localhost:7077 --webui-port 8082 &&
      tail -f /opt/spark/logs/spark--org.apache.spark.deploy.worker.Worker-*.out"
    network_mode: "host"
    depends_on:
      - spark-master
    restart: unless-stopped